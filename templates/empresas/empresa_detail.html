{% extends "app_base.html" %}
{% load static %}
{% block page_title %}
{{ empresa.name }}
{% load humanize %}
{% endblock %}

{% block body_class %}background_grey{% endblock %}

{% block cdn_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
{% endblock cdn_css %}
 
{% block content %}



<div class="parallax-container">
    <div class="parallax"><img src="{% static 'images/cambodia-1476378_1920.jpg' %}"></div>
</div>

<div class="container">
    <div class="row">
        <div class="col s9">
            <h3>{{ empresa.name }}</h3>
        </div>
        <div class="col s3">
            <p>
              <input type="checkbox" id="add_client" class="right large" name="opportunity" {% if checked_client == 1 %} checked="checked" {% endif %}/>
              <label for="add_client" class="valign">Interesting client</label>
              <span id="client_response"></span>
            </p>
            <p>
              <input type="checkbox" id="add_provider" class="right large" name="opportunity" {% if checked_providers == 1 %} checked="checked" {% endif %}/>
              <label for="add_provider" class="valign">Interesting provider</label>
              <span id="provider_response"></span>
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col s12 m3">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title">Último ejercicio</span>
              {% if empresa.estados_financieros.last.ejercicio %}
              <h5 class="align-right orange-text darken-1">{{empresa.estados_financieros.last.ejercicio}}</h5>
              {% else %}
              <h4 class="align-right orange-text darken-1">Sin balances</h4>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col s12 m3">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title">Ventas</span>
              {% if empresa.estados_financieros.last.ventas %}
              <h5 class="align-right orange-text darken-1">{{empresa.estados_financieros.last.ventas|floatformat|intcomma}}€</h5>
              {% else %}
              <h4 class="align-right orange-text darken-1">-</h4>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col s12 m3">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title">EBITDA</span>
              {% if empresa.estados_financieros.last.ebitda %}
              <h5 class="align-right orange-text darken-1">{{empresa.estados_financieros.last.ebitda|floatformat|intcomma}}€</h5>
              {% else %}
              <h4 class="align-right orange-text darken-1">-</h4>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col s12 m3">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title">Riesgo</span>
              {% if empresa.hats_alert %}
              {% if empresa.hats_alert == "ROJA" %}
              <h5 class="align-right red-text darken-1">{{empresa.hats_alert}}</h5>
              {% elif empresa.hats_alert == "AMARILLA" %}
              <h5 class="align-right yellow-text darken-1">{{empresa.hats_alert}}</h5>
              {% elif empresa.hats_alert == "VERDE" %}
              <h5 class="align-right green-text darken-1">{{empresa.hats_alert}}</h5>
              {% endif %}
              {% else %}
              <h4 class="align-right orange-text darken-1">-</h4>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

    <div class="row">
        <div class="col s12 m6">
            <h5>Contact details</h5>
            <div><i class="tiny material-icons">contacts</i> {{empresa.name}} | {{empresa.contact_person}}</div>  
            <div><i class="tiny material-icons">email</i> {{empresa.email}}</div>
            <div><i class="tiny material-icons">location_on</i>{{empresa.address}}</div>   
            <div><i class="tiny material-icons">call</i> {{empresa.phone}}</div>   
            <div><i class="tiny material-icons">business</i> Sector: {{ empresa.sector }}</div>   
            <div><i class="tiny material-icons">info</i> CNAE: {{ empresa.cnae_2 }}</div>  
            <div><i class="tiny material-icons">schedule</i> Created in {{ empresa.creation_date }}</div>
            <div class="right-align"><a href="mailto:{{empresa.email}}?Subject=Hello%20{{empresa.name}}" target="_top" class="btn-large waves-effect waves-light right-align"><i class="material-icons right">email</i>Contact</a></div>
        </div>
        <div class="col s12 m6">
            <div id="map"> </div>
        </div>
    </div>
    <hr>
    <!-- Graficos para el dashboard... vamos allà!!! vamonos!! -->
    {% if empresa.estados_financieros.last.ejercicio %}
    <div class="row">
        <div class="col s12 m6">
          <div class="card grey lighten-4">
            <div class="card-content grey-text darken-4">
              <span class="card-title">Volumen de ventas</span>
              <canvas id="barChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>
        <div class="col s12 m6">
          <div class="card grey lighten-4">
            <div class="card-content grey-text darken-4">
              <span class="card-title">EBITDA - Resultado Explotación</span>
              <canvas id="lineChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>
    </div>

    {% endif %}
    <div class="row">
        <div class="col s12 m4">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title"># Clients</span>
              <h3 class="align-right orange-text darken-1">{{empresa.get_clients.count}}</h3>
            </div>
          </div>
        </div>
        <div class="col s12 m4">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title"># Providers</span>
              <h3 class="align-right orange-text darken-1">{{empresa.get_providers.count}}</h3>
            </div>
          </div>
        </div>
        <div class="col s12 m4">
          <div class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title"># Employees</span>
              <h3 class="align-right orange-text darken-1">10</h3>
            </div>
          </div>
        </div>
    </div>
    <!-- Graficos para el dashboard... vamos allà!!! vamonos!! -->

    <h3 class="light">Recent transfers from clients</h3>

    {% if empresa.destination_reference.all %}
    <div class="row">
            <table class="highlight">
                <thead>
                    <tr>
                        <th data-field="origin_id">Origin</th>
                        <th data-field="date">CNAE</th>
                        <!-- <th data-field="concept">Concept</th> -->
                        <th data-field="amount">Amount</th>
                        <th data-field="balance">Balance</th>
                        <th data-field="destination_id">Destination</th>
                        <th data-field="date">Date</th>
                        
                    </tr>
                </thead>

            
                <tbody>
                    {% for transfer in empresa.destination_reference.all %}
                        <tr>
                            <td><a href="{{ transfer.origin_reference.get_absolute_url }}">{{forloop.counter}} {{ transfer.origin_reference.name }}</a></td>
                            <td>{{ transfer.origin_reference.cnae_2 }}</td>
                            <!-- <td>{{ transfer.concept }}</td> -->
                            <td>{{ transfer.amount }}</td>
                            <td>{{ transfer.balance }}</td>
                            <td><a href="{{ transfer.destination_reference.get_absolute_url }}">{{transfer.destination_reference.name }}</a></td>
                            <td>{{ transfer.operation_data|date }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    {% else %}

        <p>No transfers to clients are available.</p>

    {% endif %}

    <h3 class="light">Recent transfers to providers</h3>

    {% if empresa.transfers.all %}
    <div class="row">
            <table class="highlight">
                <thead>
                    <tr>
                        <th data-field="origin_id">Origin</th>
                        <!-- <th data-field="concept">Concept</th> -->
                        <th data-field="amount">Amount</th>
                        <th data-field="balance">Balance</th>
                        <th data-field="destination_id">Destination</th>
                        <th data-field="date">Date</th>
                        <th data-field="date">CNAE</th>
                    </tr>
                </thead>

            
                <tbody>
                    {% for transfer in empresa.transfers.all %}
                        <tr>
                            <td><a href="{{ transfer.origin_reference.get_absolute_url }}"> {{forloop.counter}} {{ transfer.origin_reference.name }}</a></td>
                            <!-- <td>{{ transfer.concept }}</td> -->
                            <td>{{ transfer.amount }}</td>
                            <td>{{ transfer.balance }}</td>
                            <td><a href="{{ transfer.destination_reference.get_absolute_url }}">{{transfer.destination_reference.name }}</a></td>
                            <td>{{ transfer.operation_data|date }}</td>
                            <td>{{ transfer.destination_reference.cnae_2 }}</td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    {% else %}

        <p>No transfers to clients are available.</p>

    {% endif %}


    <h3 class="light">Recommended for this client</h3>

    {% if empresa.recommended.all %}
    <div class="row">
            <table class="highlight">
                <thead>
                    <tr>
                        <th data-field="empresa_recomendada">Empresa</th>
                        <th data-field="scoring">Scoring</th>
                        <th data-field="scoring">Sector</th>
                        <th data-field="scoring">CNAE</th>
                    </tr>
                </thead>

            
                <tbody>
                    {% for company in empresa.recommended.all %}
                        {% if company.similarity > 0 %}
                        <tr>
                            <td><a href="{{ obj.clientes_recomendados.get_absolute_url }}">{{ company.clientes_recomendados.name }}</a></td>
                            <td>{{ company.similarity }}</td>
                            <td>{{ company.clientes_recomendados.sector }}</td>
                            <td>{{ company.clientes_recomendados.cnae_2 }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

    {% else %}

        <p>No companies are available.</p>

    {% endif %}

<!-- 
    <h3 class="light">Add your transfer</h3>
    
    {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

    <form action="{% url 'empresas:transfer_create' empresa.id %}" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="submit" value="Add" />
    </form> -->
</div>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

<script>

    var map = L.map('map').setView([41.3931129,2.1448724], 15);
        mapLink = 
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 18,
    }).addTo(map);

    var bar = document.getElementById("barChart");
    var line = document.getElementById("lineChart");
    var ctx = document.getElementById("ctxChart");
    var spider = document.getElementById("spiderChart");

    var scatterChart = new Chart(line, {
        type: 'line',
        data: {
            labels: {{ fechas|safe }},
            datasets: [{
            label: "EBITDA",
            backgroundColor: "rgba(220,220,220,0.5)",
            borderColor: "rgba(220,220,220,0.8)",
            highlightFill: "rgba(220,220,220,0.75)",
            pointHoverBackgroundColor: "rgba(220,220,220,1)",
            showTooltip: false, //NEW OPTION DON"T NEED TO INCLUDE IT IF YOU WANT TO DISPLAY BUT WON"T HURT IF YOU DO
            data: {{ ebitda }}
        }, {
            label: "Resultados de explotación",
            backgroundColor: "rgba(47,79,79,0.5)",
            borderColor: "rgba(47,79,79,0.8)",
            highlightFill: "rgba(47,79,79,0.75)",
            pointHoverBackgroundColor: "rgba(47,79,79,1)",
            showTooltip: false, //NEW OPTION DON"T NEED TO INCLUDE IT IF YOU WANT TO DISPLAY BUT WON"T HURT IF YOU DO
            data: {{ resultado_explotacion }}
        }]},
        options: {
          responsive: true,
          pointDotRadius: 10,
          bezierCurve: false,
          scaleShowVerticalLines: false,
          scaleGridLineColor: 'black'
        }
    });

    var myChart = new Chart(bar, {
        type: 'bar',
        data: {
            labels: {{ fechas|safe }},
            datasets: [{
                label: "Ventas",
                data: JSON.parse( "{{ ventas }}" ),
                backgroundColor: [
                    
                    'rgba(192,192,192, 0.2)',
                    'rgba(169,169,169, 0.2)',
                    'rgba(119,136,153, 0.2)',
                    'rgba(47,79,79, 0.2)',
                    'rgba(128,128,128, 0.2)',
                    'rgba(220,220,220, 0.2)'
                ],
                borderColor: [
                    
                    'rgba(192,192,192, 1)',
                    'rgba(169,169,169, 1)',
                    'rgba(119,136,153, 1)',
                    'rgba(47,79,79, 1)',
                    'rgba(128,128,128, 1)',
                    'rgba(220,220,220, 1)',
                ],
                borderWidth: 2
            }]
        },
        options: {
            legend: {
                display: false,
                labels: {
                    fontColor: 'rgb(255, 99, 132)'
                }
            },
            title: {
                display: true,
                text: 'Ventas en los últimos ejercicios'
            },
            responsive: true,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero:true
                    }
                }]
            }
        }
    });

</script>

{% endblock %}

{% block alt_js %}
<script type="text/javascript">
    var empresa_id = {{empresa.id}};

    $("#add_client" ).click(function() {
      $.ajax({
        
        url: '/empresas/'+empresa_id,

        type: 'get',
        data:{ opp_client: $( "#add_client" ).is(':checked')}})
          .done( function (responseText) {
                  // Triggered if response status code is 200 (OK)
                  if ($( "#add_client" ).is(':checked')==true) {
                    Materialize.toast('Added to your interesting clients', 4000);
                  } else {
                    Materialize.toast('Removed from your interesting clients', 4000);
                  }
                  // $('#client_response').html(responseText);
               })
               .fail( function (jqXHR, status, error) {
                  // Triggered if response status code is NOT 200 (OK)
                  alert(jqXHR.responseText);
               })
               .always( function() {
                  // Always run after .done() or .fail()
               });

    });

    $("#add_provider" ).click(function() {
      $.ajax({
        
        url: '/empresas/'+empresa_id,

        type: 'get',
        data:{ opp_provider: $( "#add_provider" ).is(':checked')}})
          .done( function (responseText) {
                  // Triggered if response status code is 200 (OK)
                  if ($( "#add_provider" ).is(':checked')==true) {
                    Materialize.toast('Added to your interesting providers', 4000);
                  } else {
                    Materialize.toast('Removed from your interesting providers', 4000);
                  }
                  // $('#provider_response').html(responseText);
               })
               .fail( function (jqXHR, status, error) {
                  // Triggered if response status code is NOT 200 (OK)
                  alert(jqXHR.responseText);
               })
               .always( function() {
                  // Always run after .done() or .fail()
               });

    });
</script>
{% endblock alt_js %}